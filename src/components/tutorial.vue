<i18n>
{
  "en": {
    "master": {
      "empty": "Hello!|Let's walk you through the basics|Choose a strong Master Password|Memorize it or write it down...|...and enter it below",
      "password": "Excellent choice!|You might be wondering what those emoji mean{\"silent\":\"sweaty\"}They represent your Master Password in a unique way|It is very easy to check that you typed it correctly|Even if a single character is off|The emoji won't be the same|Don't be worried about revealing your password, though|Master Password can't be recovered from them|Let's hit \"@:(button.next)\" button{\"delay\":true}",
      "confirm": "Still remember your Master Password?|Let's type it one more time to confirm|If something is wrong, you can start from scratch by hitting \"@:(button.reset)\"{\"delay\":true}",
      "submit": "Perfect!|Click \"@:(button.start)\" to continue"
    },
    "application-list": {
      "first": "You don't have any applications yet|Let's fix this by creating one|Click \"@:(button.add-app)\" to continue{\"delay\":true}"
    },
    "application": {
      "empty": "What the heck is \"Application\"?|Suppose that you'd like to register on a website: fancypillows.com|Naturally, they ask you to provide a password|Instead of choosing one manually, you could use DerivePass{\"silent\":\"glasses\"}Type the name of website in \"@:(label.domain)\" field to continue{\"delay\":true}",
      "domain": "Fantastic!{\"silent\":\"thumb\"}Now let's fill \"@:(label.login)\" field{\"delay\":true}",
      "username": "Lovely{\"silent\":\"heart\"}Generate the password password by hitting \"@:(button.compute.idle)\"",
      "password": "Copy the password by clicking \"@:(button.copy.ready)\"|Saving the application will complete this tutorial{\"delay\":true}"
    }
  },
  "ru": {
    "master": {
      "empty": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ!|–î–∞–≤–∞–π—Ç–µ –≤–º–µ—Å—Ç–µ —Ä–∞–∑–±–µ—Ä–µ–º—Å—è, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è DerivePass|–í—ã–±–µ—Ä–∏—Ç–µ –Ω–∞–¥–µ–∂–Ω—ã–π –ú–∞—Å—Ç–µ—Ä –ü–∞—Ä–æ–ª—å|–ó–∞–ø–æ–º–Ω–∏—Ç–µ –µ–≥–æ –∏–ª–∏ –∑–∞–ø–∏—à–∏—Ç–µ...|...–∏ –≤–≤–µ–¥–∏—Ç–µ –µ–≥–æ –≤ –ø–æ–ª–µ –Ω–∏–∂–µ",
      "password": "–ü—Ä–µ–∫—Ä–∞—Å–Ω—ã–π –≤—ã–±–æ—Ä!|–í–æ–∑–º–æ–∂–Ω–æ, –≤–∞—Å –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏ emoji –≤–Ω–∏–∑—É?{\"silent\":\"sweaty\"}–û–Ω–∏ —É–Ω–∏–∫–∞–ª—å–Ω–æ –ø–æ–¥–æ–±—Ä–∞–Ω—ã –¥–ª—è –≤–∞—à–µ–≥–æ –ú–∞—Å—Ç–µ—Ä –ü–∞—Ä–æ–ª—è|–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤–≤–æ–¥–∞ –æ—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ|–ï—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Å–∏–º–≤–æ–ª –±—ã–ª –Ω–∞–±—Ä–∞–Ω –Ω–µ–≤–µ—Ä–Ω–æ|Emoji –±—É–¥—É—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç —Ç–µ—Ö, —á—Ç–æ –≤—ã –≤–∏–¥–∏—Ç–µ —Å–µ–π—á–∞—Å|–ù–µ—Å–º–æ—Ç—Ä—è –Ω–∞ —ç—Ç–æ, –ú–∞—Å—Ç–µ—Ä –ü–∞—Ä–æ–ª—å –Ω–µ–ª—å–∑—è –ø–æ–¥–≥–ª—è–¥–µ—Ç—å –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–∑ emoji|–î–∞–≤–∞–π—Ç–µ –Ω–∞–∂–º–µ–º \"@:(button.next)\"{\"delay\":true}",
      "confirm": "–í—Å–µ –µ—â–µ –ø–æ–º–Ω–∏—Ç–µ –≤–∞—à –ú–∞—Å—Ç–µ—Ä –ü–∞—Ä–æ–ª—å?|–í–≤–µ–¥–∏—Ç–µ –µ–≥–æ –µ—â–µ –æ–¥–∏–Ω —Ä–∞–∑ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è|–ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫, –≤—ã –≤—Å–µ–≥–¥–∞ –º–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞, –Ω–∞–∂–∞–≤ \"@:(button.reset)\"{\"delay\":true}",
      "submit": "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ!|–ù–∞–∂–º–∏—Ç–µ \"@:(button.start)\", —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
    },
    "application-list": {
      "first": "–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π|–î–∞–≤–∞–π—Ç–µ –∏—Å–ø—Ä–∞–≤–∏–º —ç—Ç–æ, —Å–æ–∑–¥–∞–≤ –æ–¥–Ω–æ!|–ù–∞–∂–º–∏—Ç–µ \"@:(button.add-app)\" –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è{\"delay\":true}"
    },
    "application": {
    "empty": "–ß—Ç–æ —Ç–∞–∫–æ–µ \"–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ\"?|–î–æ–ø—É—Å—Ç–∏–º, –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è –Ω–∞ –≤–µ–±-—Å–∞–π—Ç–µ: fancypillows.com|–î–ª—è —ç—Ç–æ–≥–æ –≤–∞–º, –Ω–∞–≤–µ—Ä–Ω—è–∫–∞, –±—É–¥–µ—Ç –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤—ã–±—Ä–∞—Ç—å –ø–∞—Ä–æ–ª—å|–í–º–µ—Å—Ç–æ —Ç–æ–≥–æ, —á—Ç–æ–±—ã –≤—ã–±–∏—Ä–∞—Ç—å –µ–≥–æ –≤—Ä—É—á–Ω—É—é, –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å DerivePass{\"silent\":\"glasses\"}–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ–±-—Å–∞–π—Ç–∞ –≤ –ø–æ–ª–µ \"@:(label.domain)\", —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å{\"delay\":true}",
      "domain": "–ü—Ä–µ–∫—Ä–∞—Å–Ω–æ!{\"silent\":\"thumb\"}–¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π—Ç–µ –∑–∞–ø–æ–ª–Ω–∏–º –ø–æ–ª–µ \"@:(label.login)\"{\"delay\":true}",
      "username": "–ò–∑—É–º–∏—Ç–µ–ª—å–Ω–æ!{\"silent\":\"heart\"}–í—ã –º–æ–∂–µ—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä–æ–ª—å, –Ω–∞–∂–∞–≤ \"@:(button.compute.idle)\"",
      "password": "–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–∞—Ä–æ–ª—å, —â–µ–ª–∫–Ω—É–≤ –ø–æ \"@:(button.copy.ready)\"|–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–∏—Ç –Ω–∞—à–µ –æ–±—É—á–µ–Ω–∏–µ{\"delay\":true}"
    }
  },
  "ca": {
    "master": {
      "empty": "Hola!|Anem a veure els b√†sics|Escull una Contrasenya Mestre forta|Memoritza-la, o anota-te-la...|...i introdueix-la a continuaci√≥",
      "password": "Genial elecci√≥!!|Deus estar pensant qu√® signifiquen aquests emoji{\"silent\":\"sweaty\"}Representen la teva Contrasenya Mestre d'una manera √∫nica|√âs molt f√†cil comprovar que l'has escrita correctament|Incl√∫s si et deixes un sol car√†cter|Els emoji no seran els mateixos|No pateixis si reveles una contrasenya per aix√≤|La Contrasenya Mestre no es pot extreure d'elles|Va, apretem el bot√≥ \"@:(button.next)\"{\"delay\":true}",
      "confirm": "Encara recordes la teva Contrasenya Mestre?|Va, posa-la un cop m√©s per confirmar-ho|Si res esta malament, pots comen√ßar de nou prement el bot√≥ \"@:(button.reset)\"{\"delay\":true}",
      "submit": "Perfecte!|Prem \"@:(button.start)\" per continuar"
    },
    "application-list": {
      "first": "Encara no tens cap aplicaci√≥|Solucionem-ho afegeint-ne una|Prem \"@:(button.add-app)\" per continuar{\"delay\":true}"
    },
    "application": {
      "empty": "Qu√® nassos √©s \"Aplicaci√≥\"?|Suposa que vols registrar-te a un lloc web: coixins-guais.cat|Naturalment, et demanaran una contrasenya|Enlloc de triar-ne una manualment, pots emprar DerivePass{\"silent\":\"glasses\"}Escriu el nom del lloc web al camp \"@:(label.domain)\" per continuar{\"delay\":true}",
      "domain": "Fant√†stic!{\"silent\":\"thumb\"}Ara omple el camp \"@:(label.login)\"{\"delay\":true}",
      "username": "Preci√≥s{\"silent\":\"heart\"}Genera la contrasenya prement \"@:(button.compute.idle)\"",
      "password": "Copia la contrasenya prement \"@:(button.copy.ready)\"|Desa l'aplicaci√≥ per completar aquest tutorial{\"delay\":true}"
    }
  }
}
</i18n>

<template>
  <section class="tutorial">
    <b-popover
      target="tutorial-emoji"
      :show="computeText().length !== 0"
      placement="top">
      <div class="text-center">{{ computeText() }}</div>
    </b-popover>
    <section id="tutorial-emoji" class="text-center">
      {{ emoji }}
    </section>
  </section>
</template>

<script>
import bPopover from 'bootstrap-vue/es/components/popover/popover';

const SPEAKING = [
  'üôÇ',
  'üòÆ',
  'üòÄ',
  'üòê',
];

const SILENT = {
  'teeth': 'üò¨',
  'sweaty': 'üòÖ',
  'glasses': 'üòé',
  'thumb': 'üëç',
  'heart': 'ü•∞',
};

const DEFAULT_DELAY = 60;

const SPLIT_RE = /\||(\{[^}]*\})/g

export default {
  name: 'tutorial',

  components: { bPopover },
  props: {
    state: { type: String, required: true }
  },

  data() {
    return { timer: null, index: { letter: -10, sentence: -1 }, silent: null };
  },

  mounted() {
    this.timer = setInterval(() => {
      this.index.letter++;
    }, 60);
  },

  destroyed() {
    clearInterval(this.timer);
  },

  computed: {
    emoji() {
      if (this.index.letter < 0) {
        return SILENT[this.silent || 'teeth'];
      }

      return SPEAKING[this.index.letter % SPEAKING.length];
    },

    message() {
      let msg = this.$t(this.state);

      // Parse separators
      const separators = [];
      msg = msg.replace(SPLIT_RE, (_, json) => {
        separators.push(json ? JSON.parse(json) : {});
        return '|';
      })

      // Remove trailing separator before splitting
      msg = msg.replace(/\|$/, '');

      const sentences = msg.split('|');

      // Allow trailing separator
      if (separators.length < sentences.length) {
        separators.push({});
      }

      return { sentences, separators };
    },
  },

  methods: {
    computeText() {
      const index = this.index;

      const { sentences, separators } = this.message;

      if (sentences.length === 0) {
        this.silent = null;
        return '';
      }

      if (index.letter < 0) {
        if (index.sentence === -1) {
          return '';
        }

        let prev = index.sentence - 1;
        if (prev < 0) {
          prev += sentences.length;
        }
        this.silent = separators[prev].silent;
        return sentences[prev];
      }

      // Initial
      if (index.sentence < 0) {
        index.sentence = 0;
      }

      this.silent = null;

      const sentence = sentences[index.sentence];
      const current = 1 + index.letter % sentence.length;

      const result = sentence.slice(0, current);
      if (current >= sentence.length) {
        index.letter = -(separators[index.sentence].delay ? 2 : 1) *
          DEFAULT_DELAY;
        index.sentence++;
        index.sentence %= sentences.length;
      }
      return result.trim();
    }
  },

  watch: {
    state() {
      this.index.sentence = 0;
      this.index.letter = 0;
    },
  },
};
</script>

<style scoped>
.tutorial {
  font-size: 48px;
  font-family: Apple Color Emoji;
}
</style>
